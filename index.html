<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Spektra CP</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Spektra CP">
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23c40000%22/><text y=%22.9em%22 x=%2250%25%22 font-family=%22Inter, sans-serif%22 font-weight=%22bold%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>CP</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23c40000%22/><text y=%22.9em%22 x=%2250%25%22 font-family=%22Inter, sans-serif%22 font-weight=%22bold%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>CP</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --red:#c40000; --blue:#0056b3; --navy:#0f172a; --gray:#64748b; --border:#e2e8f0; --bg:#f8fafc; --profit:#10b981; --orange:#f59e0b; }
    * { box-sizing:border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: #1e293b; padding-bottom: 50px; }
    .no-print { max-width: 1250px; margin: 20px auto; padding: 0 20px; }
    .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: var(--navy); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    .dash-box { text-align: center; border-right: 1px solid #334155; }
    .dash-box:last-child { border-right: none; }
    .dash-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; display: block; }
    .dash-val { font-size: 18px; font-weight: bold; color: var(--profit); }
    h3 { margin-top: 0; color: var(--red); border-bottom: 2px solid var(--red); padding-bottom: 10px; font-size: 18px; }
    .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; }
    .editor-table { width: 100%; border-collapse: collapse; }
    .editor-table th { text-align: left; font-size: 11px; color: var(--gray); text-transform: uppercase; padding: 10px; }
    .editor-table td { padding: 10px 5px; border-bottom: 1px solid var(--border); }
    .action-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .btn { padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; font-size: 14px; flex: 1; min-width: 140px; text-align: center; }
    .btn-add { background: var(--blue); color: white; }
    .btn-print { background: var(--red); color: white; }
    .btn-save { background: var(--profit); color: white; }
    .btn-load { background: var(--orange); color: white; }
    .btn-new { background: #475569; color: white; }
    #print-area { width: 210mm; min-height: 297mm; padding: 15mm; margin: 20px auto; background: white; border: 1px solid #ddd; }
    .doc-header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--red); padding-bottom: 15px; margin-bottom: 20px; }
    .doc-logo img { height: 70px; }
    .doc-center { text-align: center; flex: 1; }
    .doc-center h2 { color: var(--red); margin: 0; font-size: 22px; }
    .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .preview-table th { background: #f8fafc; border: 1px solid var(--border); font-size: 11px; padding: 8px; text-align: left; }
    .preview-table td { border: 1px solid var(--border); padding: 8px; font-size: 12px; }
    .rekapitulacia { border: 2px solid var(--border); border-radius: 10px; padding: 15px; }
    .rek-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
    .rek-total { color: var(--red); font-weight: bold; font-size: 18px; border-bottom: none; margin-top: 10px; }
    @media print { .no-print { display: none !important; } #print-area { margin: 0; border: none; width: 100%; } }
  </style>
</head>
<body>

<div class="no-print">
  <div class="card" style="background: var(--navy); border:none;">
    <div class="dashboard">
      <div class="dash-box"><span class="dash-label">Zisk (30%)</span><span class="dash-val" id="stat-margin">0 ‚Ç¨</span></div>
      <div class="dash-box"><span class="dash-label">Krytie r√©≈æie</span><span class="dash-val" id="stat-coverage" style="color:#fbbf24;">0 %</span></div>
      <div class="dash-box"><span class="dash-label">ƒåist√Ω v√Ωnos</span><span class="dash-val" id="stat-net" style="color:#60a5fa;">0 ‚Ç¨</span></div>
    </div>
  </div>

  <div class="card">
    <h3>Z√°kazn√≠k a Projekt</h3>
    <div class="grid-inputs">
      <input type="text" id="custName" placeholder="Meno z√°kazn√≠ka / Projekt" oninput="updateAll()">
      <input type="text" id="cpNumber" placeholder="ƒå√≠slo ponuky" readonly style="background:#f1f5f9;">
      <select id="vatRate" onchange="updateAll()"><option value="23">DPH 23%</option><option value="20">DPH 20%</option><option value="0">Bez DPH</option></select>
    </div>
  </div>

  <div class="card">
    <h3>Polo≈æky Ponuky</h3>
    <table class="editor-table">
      <thead><tr><th>Popis / Katal√≥g</th><th width="80">Mno≈æ.</th><th width="100">Cena ‚Ç¨</th><th width="100" style="text-align:right">Spolu</th><th width="40"></th></tr></thead>
      <tbody id="editorBody"></tbody>
    </table>
    <div class="action-bar">
      <button class="btn btn-add" onclick="addRow()">+ Prida≈• polo≈æku</button>
      <button class="btn btn-print" onclick="window.print()">Vytlaƒçi≈• PDF</button>
      <button class="btn btn-save" onclick="saveToArchive()">üíæ Ulo≈æi≈• Arch√≠v</button>
      <button class="btn btn-load" onclick="document.getElementById('fileInput').click()">üìÇ Naƒç√≠ta≈•</button>
      <button class="btn btn-new" onclick="createNewOffer()">Reset</button>
    </div>
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="loadFromArchive(event)">
  </div>
</div>

<div id="print-area">
  <div class="doc-header">
    <div class="doc-logo"><img src="logo.png" alt="Spektra" onerror="this.src='https://via.placeholder.com/150x70?text=Spektra+Install'"></div>
    <div class="doc-center"><h2 id="prev-doc-title">CENOV√Å PONUKA</h2><div id="prev-cp" style="font-size:11px;font-weight:bold;color:var(--gray);"></div><div id="prev-project" style="font-size:12px;margin-top:5px;font-weight:bold;"></div></div>
    <div style="text-align:right; font-size:10px;"><b>Spektra Install s.r.o.</b><br>Rosinsk√° cesta 13, ≈Ωilina<br>IƒåO: 50003361</div>
  </div>
  <table class="preview-table">
    <thead><tr><th>Polo≈æka - Materi√°l a odborn√° mont√°≈æ</th><th width="60" style="text-align:center">Mno≈æ.</th><th width="80" style="text-align:right">J. cena</th><th width="100" style="text-align:right">Spolu bez DPH</th></tr></thead>
    <tbody id="preview-rows"></tbody>
  </table>
  <div class="rekapitulacia">
    <div class="rek-row"><span>Z√°klad dane</span><span id="res-base">0,00 ‚Ç¨</span></div>
    <div class="rek-row"><span>DPH <span id="res-vat-perc">23</span> %</span><span id="res-vat-val">0,00 ‚Ç¨</span></div>
    <div class="rek-row rek-total"><span>CELKOV√Å SUMA S DPH</span><span id="res-total">0,00 ‚Ç¨</span></div>
  </div>
</div>

<script>
  const MESACNA_REZIA = 11650;
  const CATALOG = [
    { cat: "1. PR√çPRAVA A N√ÅVRH", items: [
      { l: "Obhliadka miesta realiz√°cie a konzult√°cia", p: 50 },
      { l: "N√°vrh syst√©mu a spracovanie v√Ωkresov", p: 150 },
      { l: "Sekacie pr√°ce a pr√≠prava trasy - BYT", p: 280 },
      { l: "Sekacie pr√°ce a pr√≠prava trasy - RD", p: 450 }
    ]},
    { cat: "2. ROZVODY VODY A ODPADU", items: [
      { l: "Mont√°≈æ rozvodov vody a odpadu (za 1 bod)", p: 45 },
      { l: "N√°stenka REHAU RAUTITAN RX+", p: 11.50 },
      { l: "Potrubie REHAU RAUTITAN Stabil 16 / bm", p: 8.50 }
    ]},
    { cat: "3. K√öRENIE A ROZDEƒΩOVAƒåE", items: [
      { l: "Rozvod potrubia k√∫renia k rozdeƒæovaƒçom / bm", p: 12 },
      { l: "Rozdeƒæovaƒç 10-okruhov√Ω (materi√°l+skrinka)", p: 580 },
      { l: "Podlahov√© k√∫renie (doska + pr√°ca) / m2", p: 42 }
    ]},
    { cat: "4. ZDROJE TEPLA - Tƒå", items: [
      { l: "Vaillant aroTHERM plus 7kW", p: 8200 },
      { l: "Panasonic Aquarea 9kW", p: 7400 },
      { l: "Hyundai Monoblok 8kW", p: 4600 },
      { l: "Midea Nature 10kW (R290)", p: 5100 }
    ]},
    { cat: "5. PLYN A PELETY", items: [
      { l: "Plynov√Ω kotol Protherm Tiger (42l)", p: 2150 },
      { l: "Peletov√Ω kotol OPOP Biopel 20kW", p: 5600 }
    ]},
    { cat: "6. MONT√Å≈ΩNE PR√ÅCE", items: [
      { l: "Mont√°≈æne pr√°ce - odborn√©", p: 35, isHourly: true }
    ]},
    { cat: "7. SK√ö≈†KY A REV√çZIE", items: [
      { l: "Tlakov√© sk√∫≈°ky a protokoly", p: 85 },
      { l: "Uvedenie do prev√°dzky a za≈°kolenie", p: 90 },
      { l: "Rev√≠zna spr√°va plyn", p: 110 }
    ]}
  ];

  let rows = JSON.parse(localStorage.getItem('rows_v3')) || [{ text: '', desc: '', qty: 1, unitPrice: 0, isHourly: false }];
  let counter = parseInt(localStorage.getItem('cp_counter')) || 1;

  function initCP() {
    const year = new Date().getFullYear();
    document.getElementById('cpNumber').value = `CP-${year}/${counter.toString().padStart(3, '0')}`;
    document.getElementById('prev-cp').innerText = document.getElementById('cpNumber').value;
  }

  function addRow() {
    rows.push({ text: '', desc: '', qty: 1, unitPrice: 0, isHourly: false });
    render();
  }

  function handleSelect(i, val) {
    let found;
    CATALOG.forEach(c => c.items.forEach(it => { if(it.l === val) found = it; }));
    if(found) {
      rows[i].text = found.l;
      rows[i].unitPrice = found.p;
      rows[i].isHourly = found.isHourly || false;
      render();
    }
  }

  function render() {
    const body = document.getElementById('editorBody');
    body.innerHTML = '';
    rows.forEach((r, i) => {
      body.innerHTML += `
        <tr>
          <td>
            <select onchange="handleSelect(${i}, this.value)" style="margin-bottom:5px">
              <option>-- V√Ωber --</option>
              ${CATALOG.map(c => `<optgroup label="${c.cat}">${c.items.map(it => `<option value="${it.l}" ${r.text===it.l?'selected':''}>${it.l}</option>`).join('')}</optgroup>`).join('')}
            </select>
            <input type="text" value="${r.desc || ''}" placeholder="Doplnkov√Ω popis..." oninput="updateData(${i}, 'desc', this.value)">
          </td>
          <td><input type="number" value="${r.qty}" oninput="updateData(${i}, 'qty', this.value)"></td>
          <td><input type="number" value="${r.unitPrice}" oninput="updateData(${i}, 'unitPrice', this.value)"></td>
          <td style="text-align:right; font-weight:bold">${(r.qty * r.unitPrice).toFixed(2)} ‚Ç¨</td>
          <td><button onclick="rows.splice(${i},1);render();" style="color:red; background:none; border:none;">‚úï</button></td>
        </tr>`;
    });
    updateAll();
  }

  function updateData(i, f, v) {
    rows[i][f] = (f === 'qty' || f === 'unitPrice') ? parseFloat(v || 0) : v;
    localStorage.setItem('rows_v3', JSON.stringify(rows));
    updateAll();
  }

  function updateAll() {
    document.getElementById('prev-project').innerText = 'Projekt: ' + (document.getElementById('custName').value || '-');
    const pRows = document.getElementById('preview-rows');
    pRows.innerHTML = '';
    let totalBase = 0;

    rows.forEach(r => {
      const line = r.qty * r.unitPrice;
      totalBase += line;
      if(r.text) {
        if(r.isHourly) {
          // Na PDF skryjeme mno≈æstvo a jednotkov√∫ cenu, uk√°≈æeme len celok
          pRows.innerHTML += `<tr><td><b>${r.text}</b><br><small>${r.desc || ''}</small></td><td colspan="2" style="text-align:right; color:#666; font-style:italic;">Komplet</td><td style="text-align:right; font-weight:bold">${line.toFixed(2)} ‚Ç¨</td></tr>`;
        } else {
          pRows.innerHTML += `<tr><td><b>${r.text}</b><br><small>${r.desc || ''}</small></td><td style="text-align:center">${r.qty}</td><td style="text-align:right">${r.unitPrice.toFixed(2)} ‚Ç¨</td><td style="text-align:right; font-weight:bold">${line.toFixed(2)} ‚Ç¨</td></tr>`;
        }
      }
    });

    const vRate = parseFloat(document.getElementById('vatRate').value);
    const vVal = totalBase * (vRate/100);
    document.getElementById('res-base').innerText = totalBase.toLocaleString('sk-SK') + ' ‚Ç¨';
    document.getElementById('res-vat-perc').innerText = vRate;
    document.getElementById('res-vat-val').innerText = vVal.toLocaleString('sk-SK') + ' ‚Ç¨';
    document.getElementById('res-total').innerText = (totalBase + vVal).toLocaleString('sk-SK') + ' ‚Ç¨';
    
    let margin = totalBase * 0.30;
    document.getElementById('stat-margin').innerText = Math.round(margin) + " ‚Ç¨";
    document.getElementById('stat-coverage').innerText = ((margin / MESACNA_REZIA) * 100).toFixed(1) + " %";
    document.getElementById('stat-net').innerText = Math.round(margin - (MESACNA_REZIA / 22)) + " ‚Ç¨";
  }

  function saveToArchive() {
    const data = { cp: document.getElementById('cpNumber').value, zakaznik: document.getElementById('custName').value, rows: rows };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${data.cp}_${data.zakaznik || 'ponuka'}.json`;
    a.click();
  }

  function loadFromArchive(event) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = JSON.parse(e.target.result);
      rows = data.rows;
      document.getElementById('custName').value = data.zakaznik || "";
      render();
    };
    reader.readAsText(event.target.files[0]);
  }

  function createNewOffer() {
    if(confirm("Vytvori≈• nov√∫ ponuku?")) {
      counter++;
      localStorage.setItem('cp_counter', counter);
      rows = [{ text: '', desc: '', qty: 1, unitPrice: 0, isHourly: false }];
      document.getElementById('custName').value = "";
      initCP();
      render();
    }
  }

  initCP();
  render();
</script>
</body>
</html>
